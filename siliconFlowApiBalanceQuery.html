<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>硅基流动余额查询工具</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #f0f2f5;
      --card: rgba(255,255,255,.75);
      --primary: #1677ff;
      --danger: #ff4d4f;
      --success: #52c41a;
      --radius: 12px;
      --blur: blur(20px);
      --shadow: 0 8px 32px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif}
    body{margin:0;background:linear-gradient(135deg,#e0c3fc 0%,#9bb5ff 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .glass-card{background:var(--card);border-radius:var(--radius);padding:24px 32px;backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);box-shadow:var(--shadow);max-width:900px;width:100%}
    h1{margin:0 0 16px;font-size:24px;font-weight:600}
    textarea{width:100%;min-height:120px;border:1px solid #d9d9d9;border-radius:var(--radius);padding:8px 12px;font-size:14px;resize:vertical}
    button{outline:none;border:none;border-radius:var(--radius);padding:8px 16px;font-size:14px;cursor:pointer;transition:.2s}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-success{background:var(--success);color:#fff}
    .btn-outline{background:transparent;border:1px solid #d9d9d9;color:#333}
    .actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .progress-bar{height:4px;background:#e0e0e0;border-radius:2px;margin:12px 0;overflow:hidden}
    .progress-bar div{height:100%;background:var(--primary);width:0;transition:.3s}
    table{width:100%;border-collapse:collapse;font-size:13px;margin-top:12px}
    th,td{padding:8px;text-align:left;border-bottom:1px solid #f0f0f0}
    th{background:var(--bg)}
    .tag{padding:2px 6px;border-radius:4px;font-size:12px;color:#fff}
    .tag.valid{background:var(--success)}
    .tag.invalid{background:var(--danger)}
    .toast{position:fixed;top:20px;right:20px;background:#000000cc;color:#fff;padding:8px 12px;border-radius:var(--radius);font-size:14px;opacity:0;transition:.3s}
    .toast.show{opacity:1}
    .hidden{display:none}
    @media(max-width:600px){.glass-card{padding:16px}}
  </style>
</head>
<body>
  <div class="glass-card">
    <h1>硅基流动余额查询工具</h1>

    <section>
      <label>API 密钥（换行或逗号分隔）</label>
      <textarea id="keysInput" placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"></textarea>
      <div class="actions">
        <button class="btn-primary" id="queryBtn">开始查询</button>
        <button class="btn-outline" id="pasteBtn">粘贴</button>
        <button class="btn-outline" id="clearBtn">清空</button>
        <span id="keyCount" style="margin-left:auto;line-height:32px;font-size:13px;color:#666">共 0 个</span>
      </div>
      <div class="progress-bar hidden"><div></div></div>
    </section>

    <section style="margin-top:20px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <select id="filterSelect" class="btn-outline">
          <option value="all">全部</option>
          <option value="valid">有余额</option>
          <option value="zero">余额为 0</option>
          <option value="invalid">无效密钥</option>
        </select>
        <div>
          <button class="btn-outline" id="copyBtn">复制筛选结果</button>
          <button class="btn-outline" id="exportBtn">导出 CSV</button>
        </div>
      </div>
      <table id="resultTable">
        <thead>
          <tr><th>密钥（掩码）</th><th>状态</th><th>余额</th><th>充值余额</th><th>查询时间</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section style="margin-top:20px">
      <div style="display:flex;justify-content:space-between">
        <h2 style="margin:0;font-size:18px">历史记录</h2>
        <button class="btn-outline" id="clearHistoryBtn">清空</button>
      </div>
      <ul id="historyList" style="padding:0;list-style:none;font-size:13px;margin-top:8px"></ul>
    </section>
  </div>

  <div id="toast" class="toast"></div>

  <script>
  /* ---------- 常量 ---------- */
  const API = 'https://api.siliconflow.cn/v1/user/info';
  const TIMEOUT = 15000;
  const CONCURRENCY = 6;
  const STORAGE_KEY = 'siliconflow_balance_query_history_v3';

  /* ---------- 工具函数 ---------- */
  const $ = sel => document.querySelector(sel);
  const sleep = ms => new Promise(r => setTimeout(r, ms));
  const toast = (msg, t = 2000) => {
    const el = $('#toast');
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), t);
  };
  const maskKey = k => k.length > 12 ? `${k.slice(0,4)}****${k.slice(-4)}` : k;

  /* ---------- 本地存储 ---------- */
  const loadHistory = () => JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
  const saveHistory = data => localStorage.setItem(STORAGE_KEY, JSON.stringify(data));

  /* ---------- 数据 ---------- */
  let allResults = [];

  /* ---------- 事件绑定 ---------- */
  $('#keysInput').addEventListener('input', e => {
    const keys = parseKeys(e.target.value);
    $('#keyCount').textContent = `共 ${keys.length} 个`;
  });
  $('#pasteBtn').addEventListener('click', () => navigator.clipboard.readText().then(t => $('#keysInput').value = t.trim()));
  $('#clearBtn').addEventListener('click', () => $('#keysInput').value = '');
  $('#queryBtn').addEventListener('click', startQuery);
  $('#filterSelect').addEventListener('change', renderTable);
  $('#copyBtn').addEventListener('click', copyFiltered);
  $('#exportBtn').addEventListener('click', exportCSV);
  $('#clearHistoryBtn').addEventListener('click', () => confirm('确定清空历史记录？') && (saveHistory({}), renderHistory()));

  /* ---------- 主函数 ---------- */
  function parseKeys(text) {
    return [...new Set(text.split(/[\n,]+/).map(k => k.trim()).filter(Boolean))];
  }

  async function startQuery() {
    const keys = parseKeys($('#keysInput').value);
    if (!keys.length) return toast('请输入 API 密钥');
    $('#queryBtn').disabled = true;
    $('.progress-bar').classList.remove('hidden');
    const progress = $('.progress-bar div');
    allResults = [];
    renderTable();

    const controller = new AbortController();
    let finished = 0;

    const run = async (key) => {
      try {
        const res = await fetch(API, {
          method: 'GET',
          headers: { Authorization: `Bearer ${key}` },
          signal: controller.signal
        });
        if (!res.ok) throw new Error(res.status);
        const data = await res.json();
        const balance = parseFloat(data.data.totalBalance || 0);
        const chargeBalance = parseFloat(data.data.chargeBalance || 0);
        return { key, status: 'valid', balance, chargeBalance, time: new Date() };
      } catch (e) {
        return { key, status: e.message === '401' ? 'invalid' : 'error', balance: null, time: new Date() };
      } finally {
        finished++;
        progress.style.width = `${(finished / keys.length) * 100}%`;
      }
    };

    const promises = [];
    for (let i = 0; i < keys.length; i += CONCURRENCY) {
      const chunk = keys.slice(i, i + CONCURRENCY).map(run);
      promises.push(...chunk);
      await Promise.all(chunk);
    }

    allResults = await Promise.all(promises);
    $('#queryBtn').disabled = false;
    $('.progress-bar').classList.add('hidden');
    toast('查询完成');
    renderTable();
    saveSnapshot(keys, allResults);
  }

  function renderTable() {
    const filter = $('#filterSelect').value;
    const tbody = $('#resultTable tbody');
    tbody.innerHTML = '';
    const filtered = allResults.filter(r => {
      if (filter === 'all') return true;
      if (filter === 'valid') return r.status === 'valid' && r.balance > 0;
      if (filter === 'zero') return r.status === 'valid' && r.balance === 0;
      if (filter === 'invalid') return r.status === 'invalid';
    });
    filtered.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${maskKey(r.key)}</td>
        <td><span class="tag ${r.status}">${r.status === 'valid' ? (r.balance > 0 ? '有余额' : '余额 0') : '无效'}</span></td>
        <td>${r.balance !== null ? r.balance.toFixed(4) : '-'}</td>
        <td>${r.chargeBalance !== null ? r.chargeBalance.toFixed(4) : '-'}</td>
        <td>${r.time.toLocaleTimeString()}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function copyFiltered() {
    const filter = $('#filterSelect').value;
    const filtered = allResults.filter(r => {
      if (filter === 'all') return true;
      if (filter === 'valid') return r.status === 'valid' && r.balance > 0;
      if (filter === 'zero') return r.status === 'valid' && r.balance === 0;
      if (filter === 'invalid') return r.status === 'invalid';
    });
    if (!filtered.length) return toast('无数据可复制');
    const text = filtered.map(r => r.key).join('\n');
    navigator.clipboard.writeText(text).then(() => toast('已复制'));
  }

  function exportCSV() {
    if (!allResults.length) return toast('无数据可导出');
    const header = '密钥,状态,余额,充值余额,时间\n';
    const rows = allResults.map(r => `${r.key},${r.status},${r.balance ?? ''},${r.chargeBalance ?? ''},${r.time.toISOString()}`).join('\n');
    const blob = new Blob([header + rows], { type: 'text/csv;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `siliconflow_balance_${Date.now()}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }

  function saveSnapshot(keys, results) {
    const history = loadHistory();
    const id = [...keys].sort().join('|');
    history[id] = {
      id,
      apiKeys: keys,
      snapshots: [...(history[id]?.snapshots || []), {
        date: new Date(),
        results,
        totalBalance: results.filter(r => r.status === 'valid').reduce((s, r) => s + r.balance, 0)
      }]
    };
    saveHistory(history);
    renderHistory();
  }

  function renderHistory() {
    const history = loadHistory();
    const ul = $('#historyList');
    ul.innerHTML = '';
    Object.values(history).reverse().forEach(item => {
      const li = document.createElement('li');
      li.style.display = 'flex'; li.style.justifyContent = 'space-between'; li.style.padding = '6px 0'; li.style.borderBottom = '1px solid #eee';
      const last = item.snapshots[item.snapshots.length - 1];
      li.innerHTML = `
        <span>${item.apiKeys.length} 个密钥 · 总余额 ${last.totalBalance.toFixed(4)} · ${new Date(last.date).toLocaleString()}</span>
        <button class="btn-outline" style="font-size:12px;padding:2px 8px">重新查询</button>
      `;
      li.querySelector('button').onclick = () => {
        $('#keysInput').value = item.apiKeys.join('\n');
        startQuery();
      };
      ul.appendChild(li);
    });
  }

  /* ---------- 初始化 ---------- */
  renderHistory();
  </script>
</body>
</html>